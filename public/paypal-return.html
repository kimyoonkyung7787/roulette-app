<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>결제 완료 - Roulette Premium</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      background: #0a0a0f;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
      text-align: center;
    }
    .card {
      background: #1a1a2e;
      border: 2px solid #00ffff;
      border-radius: 24px;
      padding: 32px;
      max-width: 400px;
      box-shadow: 0 0 25px rgba(0, 255, 255, 0.25);
    }
    h1 { color: #00ffff; font-size: 24px; margin-bottom: 16px; }
    p { color: #94a3b8; line-height: 1.6; margin-bottom: 24px; }
    .btn {
      display: inline-block;
      background: #00ffff;
      color: #000;
      padding: 14px 28px;
      border-radius: 16px;
      font-weight: 900;
      text-decoration: none;
      cursor: pointer;
      border: none;
      font-size: 16px;
    }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .error { color: #ef4444; }
    .spinner { display: inline-block; width: 24px; height: 24px; border: 3px solid rgba(0,255,255,0.3); border-top-color: #00ffff; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="card">
    <div id="content">
      <div class="spinner"></div>
      <p>결제 확인 중...</p>
    </div>
    <button id="btn" class="btn" style="display:none" disabled>앱으로 돌아가기</button>
  </div>
  <script>
    (function() {
      const params = new URLSearchParams(window.location.search);
      // PayPal redirects with ?token=ORDER_ID&PayerID=PAYER_ID
      const orderId = params.get('token') || params.get('orderId');
      const idToUse = orderId;

      const baseUrl = window.location.origin.includes('localhost') 
        ? 'https://roulette-app-two.vercel.app' 
        : window.location.origin;

      const content = document.getElementById('content');
      const btn = document.getElementById('btn');

      function showResult(success, message) {
        content.innerHTML = success 
          ? '<h1>✓ 결제 완료!</h1><p>' + message + '</p>'
          : '<h1 class="error">오류</h1><p class="error">' + message + '</p>';
        btn.style.display = 'inline-block';
        btn.disabled = false;
      }

      if (!idToUse) {
        showResult(false, '결제 정보를 찾을 수 없습니다.');
        return;
      }

      fetch(baseUrl + '/api/capture-paypal-order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ orderId: idToUse })
      })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            showResult(true, '프리미엄이 활성화되었습니다. 앱으로 돌아가세요.');
            btn.textContent = '앱으로 돌아가기';
            btn.onclick = () => {
              window.location.href = 'rouletteapp://premium?orderId=' + encodeURIComponent(idToUse);
              setTimeout(() => { window.location.href = '/'; }, 500);
            };
          } else {
            showResult(false, data.error || '캡처 실패');
          }
        })
        .catch(err => {
          showResult(false, '네트워크 오류: ' + (err.message || '알 수 없음'));
        });
    })();
  </script>
</body>
</html>
